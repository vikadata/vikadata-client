image: 'vikadata/dind-aws-node'

variables:
  AWS_DEFAULT_REGION: 'cn-northwest-1'


# 构建並部署 feature 客户端
build_feature_client:
  stage: build
  image: vikadata/dind-aws-node
  only:
    - feature-autoupdater
  before_script:
    - node -v
    - yarn config set registry https://registry.npm.taobao.org
    - npm install
  script:
    - echo "开始构建Mac客户端安装包..."
    - yarn dist:dev_mac
    - echo "开始构建Window客户端安装包..."
    - yarn dist:dev_win
    - echo "Start Upload......"
    - mkdir ~/.aws/ && touch ~/.aws/credentials
    # $AWS_ACCESS_KEY_ID、$AWS_SECRET_ACCESS_KEY 分别在gitlab代码库的变量里
    - printf "[default]\naws_access_key_id = %s\naws_secret_access_key = %s\n" "$AWS_ACCESS_KEY_ID" "$AWS_SECRET_ACCESS_KEY" >> ~/.aws/credentials
    - aws s3 cp dist s3://vika-headquarters.vika.cn/integration  --recursive --include "*"
    - yarn update:vikalist
    - rm -rf dist/*
    - echo "完成部署！~"



# 构建並部署 integration 客户端
build_integration_client:
  stage: build
  only:
    - integration
  before_script:
    - node -v
    - yarn config set registry https://registry.npm.taobao.org
    - npm install
  script:
    - echo "开始构建Mac客户端安装包..."
    - yarn dist:dev_mac
    - echo "开始构建Window客户端安装包..."
    -
    - echo "Start Upload......"
    - mkdir ~/.aws/ && touch ~/.aws/credentials
    # $AWS_ACCESS_KEY_ID、$AWS_SECRET_ACCESS_KEY 分别在gitlab代码库的变量里
    - printf "[default]\naws_access_key_id = %s\naws_secret_access_key = %s\n" "$AWS_ACCESS_KEY_ID" "$AWS_SECRET_ACCESS_KEY" >> ~/.aws/credentials
    - aws s3 cp dist s3://vika-headquarters.vika.cn/integration  --recursive --include "*"
    - rm -rf dist/*
    - echo "完成部署！~"


# 构建並部署 production 客户端
build_production_client:
  stage: build
  only:
    - master
  before_script:
    - node -v
    - npm config set registry https://registry.npm.taobao.org
    - npm install
  script:
    - echo "开始部署..."
    - npm run build
    - echo "Start Upload......"
    - mkdir ~/.aws/ && touch ~/.aws/credentials
    # $AWS_ACCESS_KEY_ID、$AWS_SECRET_ACCESS_KEY 分别在gitlab代码库的变量里
    - printf "[default]\naws_access_key_id = %s\naws_secret_access_key = %s\n" "$AWS_ACCESS_KEY_ID" "$AWS_SECRET_ACCESS_KEY" >> ~/.aws/credentials
    - aws s3 cp dist s3://vika-headquarters.vika.cn/prod  --recursive --include "*"
    - rm -rf dist/*
    - echo "完成部署！~"
